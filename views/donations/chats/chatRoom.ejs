<% if (isClosed) { %>
<div class="flex flex-col items-center min-h-[60vh] py-10 w-full">
  <div class="bg-gradient-to-br from-orange-50 to-red-100 shadow-lg rounded-2xl p-10 w-full max-w-2xl text-center border border-orange-200">
    <h1 class="text-2xl font-bold text-orange-700 mb-4">대화가 종료된 채팅방입니다.</h1>
    <p class="text-orange-600 mb-6 text-base">이 채팅방은 더 이상 사용할 수 없습니다.</p>
    <a href="/donations" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold transition text-base">나눔 목록으로 돌아가기</a>
  </div>
</div>
<% } else { %>
<div class="flex flex-col h-[90vh] max-w-5xl mx-auto bg-gradient-to-br from-orange-50 to-red-100 shadow-2xl rounded-2xl overflow-hidden my-6 border border-orange-200">
  <div class="bg-orange-600 p-5 text-white flex justify-between items-center shadow-md">
    <div>
      <h2 class="font-bold text-xl">나눔 채팅방</h2>
      <p class="text-base text-orange-100">매너 있는 대화를 부탁드려요!</p>
    </div>

    <div class="flex gap-3">
      <% if (isAuthor) { %>
      <form id="end-donation" action="/donations/<%= donationId %>/chats/<%= chatRoomId %>/complete?_method=PUT" method="POST">
        <button type="submit" class="text-sm bg-green-500 px-5 py-2 rounded-lg hover:bg-green-600 transition font-semibold">
          나눔 완료
        </button>
      </form>
      <% } %>
      <a href="/donations" class="text-sm bg-orange-700 px-5 py-2 rounded-lg hover:bg-orange-800 transition font-semibold">목록</a>
    </div>
  </div>

  <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 bg-orange-50">
    <% messages.forEach(msg => { %>
    <div class="flex <%= msg.sender._id.toString() === userId.toString() ? 'justify-end' : 'justify-start' %>">
      <div class="max-w-[75%]">
        <% if (msg.sender._id.toString() !== userId.toString()) { %>
        <span class="text-xs text-orange-600 ml-2 mb-1 block"><%= msg.sender.nickname %></span>
        <% } %>
        <div class="px-4 py-2 rounded-2xl text-sm shadow-md <%= msg.sender._id.toString() === userId.toString() ? 'bg-orange-600 text-white rounded-tr-none' : 'bg-white text-orange-900 border border-orange-200 rounded-tl-none' %>">
          <%= msg.content %>
        </div>
      </div>
    </div>
    <% }); %>
  </div>

  <div class="p-5 bg-white border-t border-orange-200">
    <form id="chat-form" class="flex items-center gap-3">
      <input type="text" id="message-input" placeholder="메시지를 입력하세요..." class="flex-1 bg-gray-100 border-none rounded-full px-5 py-3 text-base focus:ring-2 focus:ring-orange-500 focus:bg-white transition" autocomplete="off">
      <button type="submit" class="bg-orange-600 p-3 rounded-full text-white hover:bg-orange-700 shadow-lg hover:scale-105 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 20 20">
          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
        </svg>
      </button>
    </form>
  </div>
</div>
<% } %>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const chatRoomId = "<%= chatRoomId %>";
  const userId = "<%= userId %>";
  const chatBox = document.getElementById('chat-box');

  // 1. 방 입장
  socket.emit('join_chat_room', chatRoomId);

  // 2. 메시지 전송
  document.getElementById('chat-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('message-input');
    if (!input.value.trim()) return;

    socket.emit('send_message', {
      chatRoom: chatRoomId,
      sender: userId,
      content: input.value
    });
    input.value = '';
  });

  // 3. 메시지 수신 시 DOM 추가
  socket.on('receive_message', (msg) => {
    const isMe = msg.sender._id === userId;
    const msgHtml = `
      <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-fade-in">
        <div class="max-w-[75%]">
          ${!isMe ? `<span class="text-[11px] text-gray-500 ml-1 mb-1 block">${msg.sender.nickname}</span>` : ''}
          <div class="px-4 py-2.5 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-200 rounded-tl-none'}">
            ${msg.content}
          </div>
        </div>
      </div>
    `;
    chatBox.insertAdjacentHTML('beforeend', msgHtml);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // 4. 나눔 종료
  document.getElementById("end-donation").addEventListener('submit', (e) => {
    e.preventDefault();
    if (confirm('정말로 나눔을 완료하시겠습니까?\n완료 후에는 채팅이 종료됩니다.')) {
      socket.emit("end-donation", {
        "chatRoom": chatRoomId,
      })
    }
  })

  // 5. 리다이렉션
  socket.on("redirection", (data) => {
    alert("나눔이 종료되었습니다.");
    window.location.href = data.redirectUrl;
  });

  socket.on("error", (data) => {
    alert(data.message);
  });

  // 초기 스크롤 하단 고정
  chatBox.scrollTop = chatBox.scrollHeight;
</script>